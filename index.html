<!DOCTYPE html>
<html lang="cs">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>V√≠kend AI ‚Äì Chat</title>

  <style>
    body {
      margin: 0;
      background: #111;
      color: #eee;
      font-family: system-ui, sans-serif;
      display: flex;
      flex-direction: column;
      height: 100vh;
    }

    header {
      padding: 8px 12px;
      background: #1b1b1b;
      display: flex;
      gap: 8px;
      align-items: center;
      border-bottom: 1px solid #222;
    }

    header input {
      background: #111;
      color: #eee;
      border: 1px solid #333;
      padding: 6px 8px;
      border-radius: 4px;
      width: 200px;
    }

    /* =========================
       üìú VE≈òEJN√Å N√ÅSTƒöNKA
       ========================= */
    #publicWall {
      background: #141414;
      border-bottom: 1px solid #222;
      padding: 12px 16px;
      max-height: 30vh;
      overflow-y: auto;
    }

    .wall-header {
      font-size: 13px;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      opacity: 0.7;
      margin-bottom: 8px;
    }

    .wall-item {
      font-size: 14px;
      padding: 6px 0;
      border-bottom: 1px dashed #2a2a2a;
      opacity: 0.9;
    }

    .wall-item:last-child {
      border-bottom: none;
    }

    #chat {
      flex: 1;
      padding: 16px;
      overflow-y: auto;
    }

    /* ================= CHAT ================= */

    .msg {
      max-width: 85%;
      padding: 10px 12px;
      border-radius: 12px;
      margin-bottom: 12px;
      word-wrap: break-word;
      animation: fadeIn 0.2s ease-out;
    }

    .msg.user {
      background: #1e2a3a;
      color: #cfe4ff;
      margin-left: auto;
      border-bottom-right-radius: 4px;
    }

    .msg.ai {
      background: #1a1a1a;
      color: #eee;
      margin-right: auto;
      border-bottom-left-radius: 4px;
    }

    .msg strong {
      display: block;
      font-size: 12px;
      opacity: 0.6;
      margin-bottom: 4px;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(2px); }
      to { opacity: 1; transform: translateY(0); }
    }

    /* ================= THINKING ================= */

    .thinking {
      font-style: italic;
      opacity: 0.85;
    }

    .dots::after {
      content: "";
      animation: dots 1.4s infinite;
    }

    @keyframes dots {
      0% { content: ""; }
      25% { content: "."; }
      50% { content: ".."; }
      75% { content: "..."; }
    }

    /* ================= FOOTER ================= */

    footer {
      display: flex;
      padding: 10px;
      background: #1b1b1b;
      gap: 10px;
      border-top: 1px solid #222;
      align-items: center;
    }

    footer input[type="text"] {
      flex: 1;
      background: #111;
      color: #eee;
      border: 1px solid #333;
      padding: 10px;
      border-radius: 4px;
    }

    button {
      background: #444;
      color: #fff;
      border: none;
      padding: 10px 16px;
      border-radius: 4px;
      cursor: pointer;
    }

    button:hover {
      background: #666;
    }

    /* ================= DEBUG ================= */

    #debugPanel {
      display: none;
      border-top: 1px solid #222;
      background: #0c0c0c;
      padding: 12px;
      max-height: 240px;
      overflow-y: auto;
      font-size: 12px;
    }

    #debugPanel pre {
      white-space: pre-wrap;
      color: #9f9;
    }

    .debug-label {
      font-size: 13px;
      opacity: 0.8;
      display: flex;
      align-items: center;
      gap: 4px;
    }
  </style>
</head>

<body>

<header>
  <span>Player:</span>
  <input id="player" value="adam" />
</header>

<!-- üìú N√ÅSTƒöNKA -->
<div id="publicWall">
  <div class="wall-header">üìú Ve≈ôejn√° n√°stƒõnka</div>
  <div id="wallContent"></div>
</div>

<div id="chat"></div>

<div id="debugPanel">
  <strong>Debug v√Ωstup</strong>
  <pre id="debugContent"></pre>
</div>

<footer>
  <label class="debug-label">
    <input type="checkbox" id="debugToggle">
    debug
  </label>

  <input id="input" type="text" placeholder="Napi≈° zpr√°vu Elis‚Ä¶" />
  <button onclick="send()">OOOdeslat</button>
</footer>

<script>
const API_URL = "https://aivikend-py-f8ava9bjejh3h6bf.westeurope-01.azurewebsites.net/api/http_trigger";

const chat = document.getElementById("chat");
const input = document.getElementById("input");
const playerInput = document.getElementById("player");
const debugToggle = document.getElementById("debugToggle");
const debugPanel = document.getElementById("debugPanel");
const debugContent = document.getElementById("debugContent");
const wallContent = document.getElementById("wallContent");

/* ================= N√ÅSTƒöNKA ================= */

async function loadPublicWall() {
  try {
    const res = await fetch(API_URL + "?mode=public_log");
    const data = await res.json();

    wallContent.innerHTML = "";

    if (!data.items?.length) {
      wallContent.innerHTML = "<div class='wall-item'>‚Äî zat√≠m ≈æ√°dn√© z√°znamy ‚Äî</div>";
      return;
    }

    data.items.slice(-7).reverse().forEach(text => {
      const div = document.createElement("div");
      div.className = "wall-item";
      div.textContent = text;
      wallContent.appendChild(div);
    });

  } catch {
    wallContent.innerHTML = "<div class='wall-item'>‚ö†Ô∏è Nelze naƒç√≠st n√°stƒõnku</div>";
  }
}

/* ================= THINKING ================= */

const thinkingStates = [
  "Omlouv√°m se za zpo≈ædƒõn√≠. Elis se chvƒõj√≠ ƒçipy vzru≈°en√≠m",
  "U≈æ to bude. Elis se bl√≠≈æ√≠ k vrcholu",
  "Elis po orgasmus skl√°d√° odpovƒõƒè trochu d√©le ne≈æ obvykle",
  "Elis mƒõla m√° moc z√°≈æitk≈Ø a je pomalej≈°√≠",
  "Elis se p≈ôipravuje na dal≈°√≠ divokou akci"
];

let thinkingEl = null;
let thinkingInterval = null;
let stateIndex = 0;

function showThinking() {
  thinkingEl = document.createElement("div");
  thinkingEl.className = "msg ai thinking";
  chat.appendChild(thinkingEl);
  updateThinkingText();

  thinkingInterval = setInterval(() => {
    stateIndex = (stateIndex + 1) % thinkingStates.length;
    updateThinkingText();
  }, 3000);
}

function updateThinkingText() {
  thinkingEl.innerHTML = `<strong>Elis</strong>${thinkingStates[stateIndex]}<span class="dots"></span>`;
}

function hideThinking() {
  if (thinkingInterval) clearInterval(thinkingInterval);
  if (thinkingEl) thinkingEl.remove();
  thinkingEl = null;
}

/* ================= CHAT ================= */

input.addEventListener("keydown", e => {
  if (e.key === "Enter") send();
});

async function send() {
  const text = input.value.trim();
  if (!text) return;

  const player = playerInput.value.trim() || "adam";
  add(player, text, "user");
  input.value = "";
  showThinking();

  try {
    const res = await fetch(API_URL, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ message: text, player })
    });
    //tady
    const raw = await res.text();
    hideThinking();

    // üîç oddƒõlen√≠ ve≈ôejn√©ho textu od UPDATE_INSTRUCTIONS
    let displayText = raw;
    let debugData = null;

    if (raw.includes("UPDATE_INSTRUCTIONS:")) {
      const parts = raw.split("UPDATE_INSTRUCTIONS:");
      displayText = parts[0].trim();

      try {
        debugData = JSON.parse(parts[1]);
      } catch {}
    }

    add("Elis", displayText, "ai");

    // debug jen pokud je zapnut√Ω
    if (debugToggle.checked && debugData) {
      renderDebug(debugData);
    }

    loadPublicWall(); // üîÅ refresh n√°stƒõnky po akci

  } catch {
    hideThinking();
    add("Chyba", "Nelze se spojit se serverem.", "ai");
  }
}

function add(author, text, cls) {
  const div = document.createElement("div");
  div.className = "msg " + cls;
  div.innerHTML = `<strong>${author}</strong>${escapeHtml(text)}`;
  chat.appendChild(div);
  chat.scrollTop = chat.scrollHeight;
}

function escapeHtml(str) {
  return str.replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;");
}

/* ================= START ================= */

loadPublicWall();
setInterval(loadPublicWall, 15000);
</script>

</body>
</html>
